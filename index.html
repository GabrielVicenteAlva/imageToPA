<html>
<head><title>Image to PAprefab converter</title></head>
<body>
<input type="file" id="file" class="button" accept="image/*" onchange="loadImage()"/><br />
Name: <input id="name" type="text" value="Image"><br />
Offset: <input id="offset" type="number" value="0"><br />
Depth: <input id="depth" type="number" value="30" min="1" max="30" step="1"><br />
Type: <select id="type">
	<option value="6">Misc1</option>
	<option value="7">Misc2</option>
	<option value="8">Misc3</option>
	<option value="9">Misc4</option>
	<option value="1">Bullet</option>
	<option value="3">Spinner</option>
	<option value="5">Character</option>
</select><br />
AutoKill Time: <input id="ako" type="number" value="10"><br />
Transparent BG: <input id="transparent" type="checkbox"><br />
<button id="generate" onclick="generate()">Generate</button><br />
<canvas id="canvas">Your browser does not support HTML5 canvas</canvas>
<script src="prefab.js"></script>
<script>
var fr,img,canvas,ctx // file reader, image, canvas, context
function loadImage() {
	var input = document.getElementById('file');
	var file = input.files[0];
	fr = new FileReader();
	fr.onload = createImage;
	fr.readAsDataURL(file);
}
function createImage() {
    img = new Image();
    img.onload = imageLoaded;
    img.src = fr.result;
    if(img.width*img.height > 20000)
    	alert('Warning: More than 20k pixels!');
}
function imageLoaded() {
    canvas = document.getElementById("canvas")
    canvas.width = img.width;
    canvas.height = img.height;
    ctx = canvas.getContext("2d");
    ctx.drawImage(img,0,0);
}
// https://stackoverflow.com/questions/19721439/download-json-object-as-a-file-from-browser
function downloadObjectAsJson(exportObj, exportName){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
    var downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href",     dataStr);
    downloadAnchorNode.setAttribute("download", exportName);
    document.body.appendChild(downloadAnchorNode); // required for firefox
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}


function hex(n){
	return ('0'+n.toString(16)).slice(-2);
}
function generate(){
	if(!document.getElementById('file').files[0]){
		alert('No file!');
		return;
	}
	prefab.name = document.getElementById("name").value;
	prefab.offset = document.getElementById("offset").value;
	prefab.type = document.getElementById("type").value;
	
	for(let o of prefab.objects){
		o.depth = document.getElementById("depth").value;
		o.ako = document.getElementById("ako").value;
	}
	var s1='',s2='',c1='',c2='',x=1,transparent = '';
	var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
	if (document.getElementById("transparent").value)
		transparent = hex(imgData[0]) + (imgData[1]) + (imgData[2]);
	for (let i = 0; i < imgData.length; i += 4) {
		var color = '';
		color += hex(imgData[i]);
		color += hex(imgData[i+1]);
		color += hex(imgData[i+2]);
		if(color==transparent)
			color = '00000000'
		if(x%2){
			if(color!=c1){
				s1 += '<color=#'+color+'>'
				c1 = color;
			}
			s1 += '█  ';
		}
		else{
			if(color!=c2){
				s2 += '<color=#'+color+'>'
				c2 = color;
			}
			s2 += '█ ';
		}
		x++;
		if(x>canvas.width){
			s1 += '<br>';
			s2 += '<br>';
			x = 1;
		}
	}
	t1.text = s1;
	t2.text = s2;
	t12.text = s1;
	t22.text = s2;
	downloadObjectAsJson(prefab,prefab.name.toLowerCase() + '.lsp');
};

var parent = new PAObject(0.,30,shapes.sq,0,objectTypes.empty,autoKillTypes.fixedTime,10);
var t1 = new PAObject(0.,30,shapes.txt(''),1,objectTypes.decoration,autoKillTypes.fixedTime,10);
var t2 = new PAObject(0.,30,shapes.txt(''),2,objectTypes.decoration,autoKillTypes.fixedTime,10);
var t12 = new PAObject(0.,30,shapes.txt(''),3,objectTypes.decoration,autoKillTypes.fixedTime,10);
var t22 = new PAObject(0.,30,shapes.txt(''),4,objectTypes.decoration,autoKillTypes.fixedTime,10);

parent.name = 'Parent';
parent.posEvent(0.,0.,0.);
parent.scaEvent(0.,1.,1.);
parent.rotEvent(0.,0.);
parent.colEvent(0.,0);

const w = .5
t1.posEvent(0.,0.,0.);
t1.scaEvent(0.,w,w*.6966667);
t1.rotEvent(0.,0.);
t1.colEvent(0.,0);
t2.posEvent(0.,w*1.5,0.);
t2.scaEvent(0.,w*1.348,w*.6966667);
t2.rotEvent(0.,0.);
t2.colEvent(0.,0);
t1.parent = parent;
t1.parentOffset(true,true,true);
t2.parent = parent;
t2.parentOffset(true,true,true);
t12.posEvent(0.,0.,w*.5);
t12.scaEvent(0.,w,w*.696667);
t12.rotEvent(0.,0.);
t12.colEvent(0.,0);
t22.posEvent(0.,w*1.5,w*.5);
t22.scaEvent(0.,w*1.348,w*.696667);
t22.rotEvent(0.,0.);
t22.colEvent(0.,0);
t12.parent = parent;
t12.parentOffset(true,true,true);
t22.parent = parent;
t22.parentOffset(true,true,true);

prefab.clean();
</script>
</body>
